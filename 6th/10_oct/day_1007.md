

[サイボウズ・ラボユース日時報告書]
---------------------------------------------------------------------------
勤務日：2016年10月07日金曜日
報告者：城倉弘樹
---------------------------------------------------------------------------
###■ 開発プロジェクト名
 slankdev/stcp.git


###■ 今日の目標

 - IPフラグメントの機能実装
     - IPのwriteでフラグメントしてデータを送れるようにする 3.0h
     - IPのreadでデフラグメントしてデータを受け取れるようにする 4.0h

###■ 作業実績 (実際にかかった時間を書いてください)

 - 10:00-18:00 mbuf関連のデバッグができるように関数追加 (うち1hは昼休み)
   -> dpdkのAPIの使い方がよく解らず、うまくいかない原因を模索
   -> 原因は判明した(おそらく)
   

###■ 達成度

達成した内容はなにもないが
デバッグ機能の重要性と
DPDKについて知見がはいったのでよし



 - mbufのメンバでdata_len, pkt_lenという2つの似たようなメンバがある。
   これらは基本的には同じ意味をもつフィールドだが、以下の場合に
   意味が変わってくる
   http://dpdk.org/doc/api/rte__mbuf_8h.html#a7a7ea614c79d5b9ed790a56c1c79189d
      - 間接アクセスmbufを使用している場合に
	      - data_lenはそのmbufが保持しているデータの長さのみを示す
	      - pkt_lenは間接アクセスできるところまでたどったデータの長さを示す

 - 自分で実装していたmbuf用のキューなのだが、これはSTLのvectorか何か
   で置き換えようと思う。
   dpdkではburst txをするときに (mbuf\*)[]の形式で渡すため、いちいちそれに
   変換するよりかは配列形式にしやすいデータ構造をしようすることにする。
   追記: ここの実装が原因で本日の実装がうまくいかないことが判明した。

 - だいぶ時間をオーバーしてしまいました
   すみません....



###■ 問題点,原因,対策 (それぞれ1,2,3で分けて書く)

本日唯一最大の問題とその解決策
 - dpdkのipv4フラグメンテーション関数で分割したパケットを送っても
   パケットのバイナリが0クリアされてしまう。
 - いままでは直接mbufを単体でallocしたりして使っていたが、
   フラグメンテーションを行う場合、分割前のmbufのメモリ空間を開放しないで
   別のmbufから参照出きるようにしていることがわかった。
   この別のmbufからの参照で使用するアクセスポイントがrte_mbufk構造体の
   next変数だった。
   これまでSTCPではrte_mbuf->nextを使ってパケットを線形リストで管理していた。
   フラグメンテーションをさせた特別なmbufの参照で使用するエリアをSTCPの
   線形リスト処理の部分で上書きをしてしまっていたためフラグメンテーションした
   mbufの送信がうまく言っていなかった.
   pktキューに関する実装を根本的に変更する必要がある
   std::vector<rte_mbuf*>で実装する予定


勤務時間外にしかできない作業
 - 環境によってうまく動いてくれないことがある 
    - CybozuのデスクトップPCでは確実に動く
    - ほかはよく調べていないからできれば週末に調べて置きたい
 - 通信テストを行うためにホストが2つは必要になるため、
   勤務時間以外はVM2つを立ち上げて作業をするので、
   それ用の環境をサクッと構築できるようにしておく


###■ 明日以降の予定

 - pktキューの修正 ->日曜日に終わらせたい
 - フラグメント送信の実装完了


###■ 作業リポジトリ履歴

本日はコードの変更はありましたが、各コミットがいつもの何倍かてきとうです。

slankdev/stcp
 - [FIX] conflict
   http://github.com/slankdev/stcp/commit/5dc56b09aa0a02cfd0168e1e1e94e2c5db783c77
 - [ADD] debug implementation
   http://github.com/slankdev/stcp/commit/bca1a9e30ebfc8cdb6f0dfa37ff8ba2b1313cf41
 - [ADD] debug implementation
   http://github.com/slankdev/stcp/commit/a8486f8dd569f6e4bbf0b84b3498574bb21aeeed
 - [Working]
   http://github.com/slankdev/stcp/commit/05f5bcebf9f5845c54bec91c2e62540f1f127d6e



参考DPDK docs
 - http://dpdk.org/doc/guides/sample_app_ug/ip_frag.html
 - http://dpdk.org/doc/api/ip_fragmentation_2main_8c-example.html
 - http://dpdk.org/doc/api/rte__ip__frag_8h.html#a0ec59118790a4babb24bd5636b1e60d9
---------------------------------------------------------------------------
