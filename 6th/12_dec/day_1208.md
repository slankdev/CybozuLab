

[サイボウズ・ラボユース日時報告書]
---------------------------------------------------------------------------
勤務日：2016年12月08日木曜日
報告者：城倉弘樹
---------------------------------------------------------------------------
###■ 開発プロジェクト名
 slankdev/stcp.git


###■ 今日の目標

 - パフォーマンス計測方法の検討と情報収集 4h
 - 実機テスト, 実装改善 3h

###■ 作業実績 (実際にかかった時間を書いてください)

 - 10:00-12:30 パフォーマンス計測についての検討, 情報収集
 - 12:30-15:00 実装ミスをいくつか発見したのでそれの修正
    - [x] RSTで終了したときにの状態遷移がおかしい問題
	- [x] iperfのクライアントモードでつないだときに落ちる問題
	- [ ] mbuf cloneで落ちる問題 -> 後日
	- [ ] tcp retransmitでhalf open状態なソケットの始末が実装されていない問題 -> 後日
 - 15:00-18:00 情報表示部分をncursesを使って再実装


###■ 達成度

60%

情報出力部分を修正する作業に時間がかかりそう。(あしたには終わるはず)
本日はまとまった進捗がないので、明日の日報に詳しくまとめます。


###■ パフォーマンス計測に関する検討

パフォーマンス計測を行う部分
 - TCPパフォーマンス (本日はこれを調べている)
 - UDPパフォーマンス (やらないかも)
 - ICMPパフォーマンス (pingの応答) -> 超簡単
 - ARPパフォーマンス (arpingの応答) -> 超簡単

比較するもの(TCP)
 - STCPのネットワークスタック上のSocketプログラム
 - Linuxのネットワークスタック上のSocketプログラム

比較するもの(ARP,ICMP)
 - Linuxのネットワークスタック
 - STCPのネットワークスタック

TCPにかんして
 - 検討した計測ツール
	- iperf
	- netperf
	- Googleでの検索結果として一番多そうなiperfを選択
 - perf計測方法
    - iperf -c SERVERIP でスループットを計測する

性能向上の余地
 - RSSを有効にする実装
 - TCP Window制御
 - 無駄な実装を修正する
    - データコピーとかバイト変換とかが無駄にやっているところがありそう
 - TCPの特定のストリームに対する最適化

これらからわかること
 - ICMP/ARP
    - DPDK(高性能ミドルウェア)やRSS(メニーコア最適化方法)の有用性
    - 無駄のない実装の証明
 - TCP
    - 無駄のない実装の証明
	- 特別な最適化方法の有用性



###■ 問題点,原因,対策 (それぞれ1,2,3で分けて書く)

MTUより大きいパケットを受信して落ちる問題
 - LinuxKernelのGROが原因だった。
   こいつにはずいぶんまえから悩まされていたのですぐに解決することができた。
   GROはTCPデフラグメンテーションを低いレイヤー(おそらくドライバレベル)で行う
   ソフトオフロード機能のことである.
   実機NICに直バインドする場合は問題が起きないはず.まだ試していない.
   (まあLinuxKernelが悪さをしているからあたりまえ)
 - mbuf_clone()で落ちる問題
   未解決. mempoolの情報をリアルタイムに出力できるようにする作業途中




###■ 明日以降の予定

 - 情報表示部分の再実装
 - cloneで落ちる問題を修正


###■ 作業リポジトリ履歴

作業中のため本日はなしでお願いします。
明日共有します。

---------------------------------------------------------------------------


