

[サイボウズ・ラボユース日次報告書]
---------------------------------------------------------------------------
勤務日：2017年 1月30日月曜日
報告者：城倉弘樹
---------------------------------------------------------------------------
###■ 開発プロジェクト名
 slankdev/susanoo.git


###■ 今日の目標

 - MultiQueue環境のテスト
 - テスト用のアプリケーションの実装
    - 大量の通信で性能が落ちる環境を構築
	- その時の最適なコアバインドパターンを模索
	  -> wkスレッドに関してはコア数を増やすことで単純にスケール
	  -> rx/txスレッドではQueue数とそれを監視するスレッドを増やすことでスケール


週末にDPDKのラップはある程度完了したので、
今日明日で使っているうちに得に問題がなさそうならば
光成さんにレビューをお願いする。


###■ 作業実績 (実際にかかった時間を書いてください)

 - 10:00-10:30 MultiQueue環境のテスト->うまく複数Queueに分散していた
 - 10:30-18:00 テスト用アプリケーションの実装
	 - リファクタリング作業
	 - pktgenで10GbpsのTx/Rxができない問題の解決 -> PCIeの帯域を使い果たしていたっぽい
	 - 星野さんマシンにx540を2枚さして、それぞれの1portをつないだらwirerateでた
	 - 規格的には1枚でもうごくはず -> 原因解明


###■ コアバインドパターンについてのメモ

優れたコアバインドの定義
 - 必要最低限度のCPUを使用する
 - wirerateが出る


###■ 達成度

50%

 - 結局どこがボトルネックで10Gbpsの全二重ができないのかわからぬ。。
 - PCIeの帯域にはあまりがあまりがあるので(計算により)原因はそれ以外にありそう
 - 単純にコアが足りてないのかと思ったが、増やしてもスケールしない
   -> そもそもpktgen-DPDKの作りがあまいのか。。
 - ボトルネックの調査として以下の方法が考えられる。
    - 自分でpktgenを書く
	- よく考える

###■ 問題点,原因,対策 (それぞれ1,2,3で分けて書く)

 - マザーボードの見方、規格についてなどができていなくて、進まない。
   これを機に勉強します


###■ 明日以降の予定

 - まずは全二重で10Gbpsが出る環境を構築する
 - パケットフィルタで全二重wirerateを出すための取り組みをする
 - 動的にコアの割り当てパターンを変化させてプログラムが自分でチューニングできるようにする
    - 自分がどの程度のパフォーマンスで動いているかを調べる機能の実装
	- コアの割り当てパターンを変更する機能の実装
	- ポートの設定などを再設定する機能の実装


勤務時間外タスク
 - shellでtabを使えるようにする
 - thrdみたいな省略はやめたほうがいいらしいので直す
 - thrd launch N で実効引数を加えたい
 - bulk処理しかできないので、アクセスが少ない時のフォワードが動かない仕様を改善
 - Command.nameを指定していない場合に例外をはく
 - 同様のCommand.nameがあった場合に例外をはく
 - makefileを少し綺麗にする
 - ビルド面倒くさい関係は当分考えないことにする

###■ 作業リポジトリ履歴

 - DPDKのファイル群をいちいちリンクするのがくそめんどくさかった問題関連
   http://d.hatena.ne.jp/pyopyopyo/20151110/p1

slankdev/susanoo.git
 - [REFACT]
   http://github.com/slankdev/susanoo/commit/70d2d0bad35f5a1875cb6e803a370918595f05d5
 - [ADD] libsusanoo
   http://github.com/slankdev/susanoo/commit/83aab9f9747643c1da9817a1fd264c4f1d3f4ef5

---------------------------------------------------------------------------
