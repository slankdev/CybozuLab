

[サイボウズ・ラボユース日時報告書]
---------------------------------------------------------------------------
勤務日：2017年 1月17日火曜日
報告者：城倉弘樹
---------------------------------------------------------------------------
###■ 開発プロジェクト名
 slankdev/stcp.git


###■ 今日の目標

 - rte_flowをラップする (5h)
 - パフォーマンス計測用のサンプルアプリケーションの実装 (2.5h)
 - DPDKをラップした部分を自己で軽くレビュー (時間が余れば)

具体的にはNICのmulti queueの動きが確認できればOKです。
それのやり方が全然わからないので、情報収集とNICの構造の更なる理解がひつようです。



###■ 作業実績 (実際にかかった時間を書いてください)

 - 10:30-16:30 Multi Queueの使い方の調査
    - NICのmulti queueの使いかたが不明なので、ドキュメントを
	  調べなたが、結局わからなかった。　(図1のような構成にしてみたかった。)
 - 16:30-17:00 Pktgenで軽く速度計測 (coreの割り当てかたと、burst sizeなどを調節)
 - 17:00-17:30 muluti queue想定の実装を無効にする
 - 17:30-18:00 今後実験で使うサンプルアプリケーションの実装


図1.

```
 +-----+ +------+                   +-----+ +------+
 |core8| |core7 |                   |core3| |core4 |
 +-----+ +------+                   +-----+ +------+

    ^       ^                          ^       ^
 +-----+ +------+ +-----+ +-----+   +-----+ +------+ +-----+ +------+
 |core1| |core2 | |core3| |core4|   |core5| |core6 | |core7| |core8 |
 +-----+ +------+ +-----+ +-----+   +-----+ +------+ +-----+ +------+

+--------------------------------+ +---------------------------------+
|+-----+ +------+ +-----+ +-----+| |+-----+ +------+ +-----+ +------+|
||ring0| |ring1 | |ring0| |ring1|| ||ring0| |ring1 | |ring0| |ring1 ||
|+--------------+ +-------------+| |+--------------+ +--------------+|
||      RX      | |      TX     || ||      RX      | |      TX      ||
|+------------------------------+| |+-------------------------------+|
|              NIC0              | |               NIC1              |
+--------------------------------+ +---------------------------------+

(core0はDPDKの制御コアとして固定)
(データの受け渡しはdpdkに用意されているロックレスringのデータ構造を使用)
(mbufのポインタを渡すことでパケット本体のコピーはないものとしている)
```

各ポートで受信したパケットを順番に各リングに渡していき、
各CPUは割り当てたringをポーリングで監視して見付次第すぐに処理(転送)をする

これによって以下のような仮説を実験してしらべたかった。

仮説:
予想として大量アクセス時には並列粒度をあげたほうがパフォーマンスがでそうだが、
大きいパケットが少量アクセスしてくる場合は並列粒度を下げたほうがパフォーマンスが
上がる

これの方法は今後引き続き調べていく。（そもそもこんなことできないのかもしれないし。。）



###■ 達成度


50%だが今後の光が見えた(マルチコアスケールする結果が若干でた)

 - Multi Queueの使い方は結局わからなかった。。
   ここでいう使い方とは受信パケットを複数HW Ringに対して自動で振り分ける使い方
 - Lagopus(DPDK使用の高速Openflow Soft Switch)ではNICのringは一つしか使ってないみたい
   なので、10G程度なら複数Ringを考えなくてもいいのかも
 - そもそも複数ringはMSI-X割り込みのためにある技術課もしれないので、pollingすることは
   考えてないのかもしれない。 -> だったら複数ringをpollingで監視するのはできなさそう
 - RSSで使用するhash値の確認、hash計算の設定などの方法は何となく分かったので、
   それならできそう

得られた興味深い知見 -> あたりまえかもしれないけど。。
(以下ではパケット処理をworkと呼ぶ)

packet size: 64bytes

num bursts: 1
 - rx/tx fwdでも全然だめ。 4Gbps程度しかでない。 (CPU時間とpacket sizeから自明ではある)
   workとtx, rxをそれぞれ別コアにわりあてればいけるのかなあ。。

num bursts: 32
 - 1コアでtx/rx/work行う場合だと10Gのワイヤーレートはすこし厳しい ただのtx/rx fwdだけで限界になりそう
 - 8コアだと余裕がありそう。 workに遅延を含ませてかくにんしてみたい　ー＞ 次回

正確にまだ調べてないので、次回調べるようにする。

 - 今週末これらの知見に関してLAC(http://www.lac.co.jp/)の勉強会で話してきます。(時間がない。。)



###■ 問題点,原因,対策 (それぞれ1,2,3で分けて書く)

 - MultiQueueの使い方がわからなかったこと。
   まずNICの構造についてよく理解できていないので、そこからしっかり調べよう
   とおもったけど。どこにそういう情報がかいてあるんだろう。。
   -> Intel NIC のデータシートが良さそう (辛そう)
 - 朝電車で寝過ごして千葉県まで到達してしまったので、気をつける


###■ 明日以降の予定

 - 分割コンパイルで.cのファイルはccでコンパイルするようにしたい
   -> 構造体の初期化構文を書き換えるのがめんどくさすぎるため。
 - DPDKの構造体の内容表示関数の実装に死ぬほど時間をとられてしまっている。。
   https://github.com/slankdev/libslankdev/blob/master/sample/dpdk/system/dpdk_struct_utils.h
   なんとかして自動化とかできないものか。。
   GDBScriptなるものを教えてもらったのですが、c言語系であつかいたいのです。


###■ 作業リポジトリ履歴

まだまとまっていないので、後ほどpushしてからコメントで追加します。

---------------------------------------------------------------------------


