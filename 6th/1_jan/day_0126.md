

[サイボウズ・ラボユース日時報告書]
---------------------------------------------------------------------------
勤務日：2017年 1月26日木曜日
報告者：城倉弘樹
---------------------------------------------------------------------------
###■ 開発プロジェクト名
 slankdev/susanoo.git


###■ 今日の目標

 - multiqueueを使えるようにする 6h
     - 情報収集 4h
     - 実装 2h
 - 実験環境の調節 (CPU速度など)をできるようにする 1h


pktgenがmultiqueue対応しているみたいなので、
それを参考にして実装する

multiqueueは本日中に完成させるつもりです。


###■ 作業実績 (実際にかかった時間を書いてください)

 - 10:00-15:00 pktgenのソースを見てMultiQueueの動作確認
     - port config系の関数に探したいものがあった。
	 - ただしかし、nuum of multi queue = 8にしても2つのqueueにしか振り分けられない
	 - CPUが高性能すぎてそんなにたくさんのqueueが必要ないと思われていると推測
	 - queue数を1つにしても同様のパフォーマンス
	 - 以下の作業を行いたかったが、できなかった。
		 - CPUクロックを落としてqueue数=1にしてパフォーマンスがでないことを確認
		 - その状態でqueue数を大きくしてパフォーマンスがスケールすることを確認
 - 15:00-15:40 いままでのメモを整理
 - 15:40-18:00 SusanooでMultiQueueをサポート -> 完了せず。。


###■ メモ RSSを有効にする方法

以下を行う

```
rxmode->mq_mode = ETH_MQ_RX_RSS ;  デフォではETH_MQ_RX_NONEになってる
conf->rx_adv_conf.rss_conf.rss_key = NULL;
conf->rx_adv_conf.rss_conf.rss_hf  = ETH_RSS_IP; だったり
conf->rx_adv_conf.rss_conf.rss_hf  = ETH_RSS_XXXX; だったり
```

動作確認はsrc ipの違うパケットをたくさん食わせてそれぞれのQを監視すると
それぞれ分散してパケットをみることができる

また、mbuf.hash.rssでパケットのhash値が確認することができる


###■ 達成度

80%

 - やることはまとまったのだが、コードのミスの修正にすごく時間がかかってしまった。
 - 全体としてメモの整理もできたのでよかったが、時間が足りない。


###■ 問題点,原因,対策 (それぞれ1,2,3で分けて書く)

 - qidとpidの間違いにまったく気づけずに時間がとてもとられた。
   次回からイテレータでfor文は回すようにしよう。


###■ 明日以降の予定

 - dpdk/ringクラスがbulk処理しか対応しておらず、大量通信時意外にうごかないので、それをなんとかする
 - MultiQueueのサポート
 - CPU周波数固定にかんしての知見をどこかにまとめておく


###■ 作業リポジトリ履歴

slankdev/susanoo.git
 - [Working] --> 作業途中です。
   http://github.com/slankdev/susanoo/commit/8dbc4967d4187851f1675d9702094f2b2dcbaa42
 - [UPDATE] makefile
   http://github.com/slankdev/susanoo/commit/6eb2db6e6a0a1cdf9ad47ed242c11fdbc55be022


---------------------------------------------------------------------------
